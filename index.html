<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether 7.1 | Natural Rain</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --accent: #00e5ff;
            --accent-glow: rgba(0, 229, 255, 0.4);
            --glass-surface: rgba(18, 18, 24, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.5);
        }

        /* Темы */
        body.mode-rain { --accent: #a855f7; --accent-glow: rgba(168, 85, 247, 0.4); }
        body.mode-ember { --accent: #f59e0b; --accent-glow: rgba(245, 158, 11, 0.4); }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter Tight', sans-serif; }

        body {
            height: 100vh;
            background: #050505;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
            transition: --accent 1s;
        }

        /* --- ФОН --- */
        .deep-bg { position: absolute; inset: 0; z-index: -2; background: radial-gradient(circle at 50% -20%, #1a1a2e, #000000); transition: background 0.4s ease; }
        body.mode-ember .deep-bg { background: radial-gradient(circle at 50% -20%, #2a1505, #000000); }
        body.mode-rain .deep-bg { background: radial-gradient(circle at 50% -20%, #180d26, #000000); }

        .ambient-glow {
            position: absolute; width: 600px; height: 600px; background: var(--accent);
            filter: blur(180px); opacity: 0.15; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            animation: breathe 10s infinite alternate ease-in-out; z-index: -2;
            transition: background 0.4s ease;
        }
        @keyframes breathe { 0% { opacity: 0.1; transform: translate(-50%, -50%) scale(0.8); } 100% { opacity: 0.2; transform: translate(-50%, -50%) scale(1.2); } }

        /* --- ЧАСТИЦЫ (НОВАЯ ФИЗИКА) --- */
        .particle-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: -1; overflow: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .particle-layer.fading { opacity: 0; }

        /* 1. Снег */
        .flake {
            position: absolute; background: white; border-radius: 50%;
            animation: fall linear infinite;
        }
        @keyframes fall {
            from { transform: translateY(-10vh) translateX(-10px); }
            to { transform: translateY(110vh) translateX(10px); }
        }

        /* 2. Дождь (Красивый) */
        .rain-drop {
            position: absolute;
            width: 1px;
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.8)); /* Градиент хвоста */
            opacity: 0.7;
            transform: rotate(15deg); /* Наклон дождя */
            animation: rainFall linear infinite;
        }
        @keyframes rainFall {
            from { transform: translateY(-20vh) translateX(0) rotate(15deg); }
            to { transform: translateY(120vh) translateX(-20px) rotate(15deg); }
        }

        /* 3. Угли */
        .ember-spark {
            position: absolute; background: #ffaa00; border-radius: 50%;
            box-shadow: 0 0 5px #ff7b00;
            animation: rise linear infinite;
        }
        @keyframes rise {
            from { transform: translateY(110vh) translateX(0); opacity: 0; }
            50% { opacity: 1; }
            to { transform: translateY(-10vh) translateX(-20px); opacity: 0; }
        }

        /* --- UI --- */
        .app-container {
            display: grid; grid-template-columns: 380px 0px; gap: 0px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative;
        }
        .app-container.playlist-open { grid-template-columns: 380px 300px; gap: 20px; }

        .player-card {
            width: 380px; background: var(--glass-surface);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 40px; border: 1px solid var(--glass-border);
            padding: 40px 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.15);
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; position: relative;
        }

        /* Кнопка погоды */
        .mood-btn {
            position: absolute; top: 25px; right: 25px;
            width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim); cursor: pointer; transition: 0.3s;
            background: rgba(255,255,255,0.05);
        }
        .mood-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        /* Плейлист */
        .playlist-panel {
            background: var(--glass-surface); backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border); border-radius: 30px; padding: 20px;
            overflow: hidden; opacity: 0; pointer-events: none;
            transform: translateX(-30px); transition: 0.4s ease;
            display: flex; flex-direction: column; height: 100%; gap: 15px;
        }
        .app-container.playlist-open .playlist-panel { opacity: 1; pointer-events: all; transform: translateX(0); }

        .search-panel {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 15px;
        }

        .search-form {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .search-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.4);
            color: var(--text-main);
            outline: none;
            font-size: 0.9rem;
        }

        .search-input::placeholder { color: rgba(255,255,255,0.4); }

        .search-btn {
            border: none;
            background: var(--accent);
            color: #000;
            padding: 0 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .search-btn:hover { box-shadow: 0 0 15px var(--accent-glow); }

        .search-status {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .search-results {
            margin-top: 10px;
            max-height: 220px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .search-results::-webkit-scrollbar { width: 3px; }
        .search-results::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .search-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.04);
            cursor: pointer;
            transition: 0.2s;
        }

        .search-item:hover { background: rgba(255,255,255,0.08); }

        .search-cover {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            object-fit: cover;
        }

        .search-info { flex: 1; }
        .search-title { font-size: 0.85rem; color: #fff; }
        .search-artist { font-size: 0.7rem; color: var(--text-dim); }

        .search-add {
            border: none;
            background: rgba(255,255,255,0.08);
            color: #fff;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .search-add:hover { background: var(--accent); color: #000; }

        /* Визуал */
        .visual-container { width: 260px; height: 260px; margin-bottom: 40px; display: flex; align-items: center; justify-content: center; position: relative; }
        .pulse-aura {
            position: absolute; inset: 10px; border-radius: 50%; background: var(--accent);
            filter: blur(40px); opacity: 0; transition: 0.8s; z-index: 0;
        }
        .album-art-wrapper {
            width: 100%; height: 100%; border-radius: 50%; position: relative; z-index: 2;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            padding: 3px;
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
        }
        .album-art {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            animation: rotateVinyl 30s linear infinite; opacity: 0.9;
            transition: opacity 0.4s ease-in-out, transform 0.4s;
            filter: saturate(0.6) brightness(0.85) contrast(1.05);
            position: relative;
            z-index: 3;
        }
        .fade-transition { opacity: 0 !important; transform: scale(0.95); }
        .playing .album-art { animation-duration: 5s; }
        @keyframes rotateVinyl { 100% { transform: rotate(360deg); } }

        /* Инфо */
        .info-area { text-align: center; width: 100%; margin-bottom: 30px; z-index: 2; }
        .track-name, .artist-name { transition: opacity 0.4s ease, color 0.4s ease; }
        .track-name { font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .artist-name { font-size: 0.9rem; color: var(--accent); font-weight: 500; letter-spacing: 1.5px; text-transform: uppercase; }

        /* Прогресс */
        .progress-area { width: 100%; margin-bottom: 35px; }
        .slider-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; position: relative; cursor: pointer; overflow: hidden; transition: height 0.2s; }
        .slider-container:hover { height: 8px; }
        .slider-fill { height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 15px var(--accent-glow); border-radius: 10px; transition: width 0.1s linear, background 0.3s ease, box-shadow 0.3s ease; }
        .timers { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-dim); margin-top: 8px; font-weight: 500; }

        /* Контролы */
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 0 10px; }
        .main-ctrls { display: flex; align-items: center; gap: 25px; }
        .ctrl-btn { background: none; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .ctrl-btn:hover { color: white; transform: scale(1.1); }
        .play-btn-circle {
            width: 75px; height: 75px; border-radius: 50%; background: var(--text-main); color: black;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            box-shadow: 0 0 20px rgba(255,255,255,0.1); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), background 1s; cursor: pointer;
        }
        .play-btn-circle:hover { transform: scale(1.1); box-shadow: 0 0 40px var(--accent-glow); background: var(--accent); }

        /* Список */
        .playlist-header { font-size: 0.8rem; text-transform: uppercase; color: #666; margin-bottom: 10px; font-weight: 700; letter-spacing: 1px; }
        .playlist-scroll { flex: 1; overflow-y: auto; padding-right: 5px; }
        .playlist-scroll::-webkit-scrollbar { width: 3px; }
        .playlist-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .track-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s, border-color 0.3s ease; margin-bottom: 5px; position: relative; }
        .track-item:hover { background: rgba(255,255,255,0.05); }
        .track-item:hover .track-delete-btn { opacity: 1; }
        .track-item.active { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--accent); }
        .track-delete-btn {
            background: none; border: none; color: rgba(255,255,255,0.3);
            cursor: pointer; font-size: 0.9rem; padding: 0;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; opacity: 0; transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .track-delete-btn:hover { background: rgba(255,0,0,0.2); color: #ff4444; }
        .t-name-mini { font-size: 0.85rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; transition: color 0.3s ease; }
        .track-item.active .t-name-mini { color: var(--accent); }
        .t-artist-mini { font-size: 0.7rem; color: rgba(255,255,255,0.4); }
        .track-text { flex: 1; display: flex; flex-direction: column; }
        .source-pill {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            background: var(--accent);
            border-radius: 999px;
            padding: 2px 8px;
        }

        .drag-msg { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s; border-radius: 40px; }
        .drag-active .drag-msg { opacity: 1; pointer-events: all; }
        .drag-msg h2 { color: var(--accent); font-size: 2rem; transition: color 0.3s ease; }

        input[type="file"] { display: none; }

    </style>
</head>
<body>

    <div class="deep-bg"></div>
    <div class="ambient-glow"></div>
    <div class="particle-layer" id="particles"></div>

    <input type="file" id="file-input" multiple accept="audio/*">

    <div class="app-container" id="appContainer">

        <div class="player-card" id="card">
            <div class="mood-btn" onclick="changeAtmosphere()" title="Атмосфера">
                <i class="fas fa-snowflake" id="moodIcon"></i>
            </div>

            <div class="drag-msg">
                <i class="fas fa-compact-disc fa-spin" style="font-size: 4rem; margin-bottom: 20px; color: var(--accent);"></i>
                <h2>Drop Files Here</h2>
            </div>

            <div class="visual-container">
                <div class="pulse-aura" id="aura"></div>
                <div class="album-art-wrapper">
                    <img src="https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=600&auto=format&fit=crop" class="album-art" id="art">
                </div>
            </div>

            <div class="info-area">
                <div class="track-name" id="title">Aether System</div>
                <div class="artist-name" id="artist">System Online</div>
            </div>

            <div class="progress-area">
                <div class="slider-container" id="seek-bar">
                    <div class="slider-fill" id="fill"></div>
                </div>
                <div class="timers">
                    <span id="curr">0:00</span>
                    <span id="dur">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="ctrl-btn" onclick="togglePlaylist()" title="Очередь"><i class="fas fa-list"></i></button>
                <div class="main-ctrls">
                    <button class="ctrl-btn" onclick="prevTrack()"><i class="fas fa-backward"></i></button>
                    <div class="play-btn-circle" id="playBtn" onclick="togglePlay()">
                        <i class="fas fa-play" style="margin-left: 4px;"></i>
                    </div>
                    <button class="ctrl-btn" onclick="nextTrack()"><i class="fas fa-forward"></i></button>
                </div>
                 <button class="ctrl-btn" onclick="document.getElementById('file-input').click()" title="Загрузить файлы"><i class="fas fa-folder-open"></i></button>
            </div>
        </div>

        <div class="playlist-panel">
            <div class="search-panel">
                <form class="search-form" id="searchForm">
                    <input type="text" id="searchInput" class="search-input" placeholder="Найти музыку в iTunes" autocomplete="off">
                    <button class="search-btn" type="submit"><i class="fas fa-search"></i></button>
                </form>
                <div class="search-status" id="searchStatus">Поиск по iTunes доступен</div>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="playlist-header">Очередь (<span id="count">0</span>)</div>
            <div class="playlist-scroll" id="playlistBox"></div>
        </div>
    </div>

    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        // --- ЧАСТИЦЫ (НАТУРАЛЬНЫЕ) ---
        const particleBox = document.getElementById('particles');
        const moodIcon = document.getElementById('moodIcon');
        let currentMode = 0;

        function initParticles(mode) {
            particleBox.innerHTML = '';

            // 0: СНЕГ
            if(mode === 0) {
                document.body.className = '';
                moodIcon.className = 'fas fa-snowflake';
                for(let i=0; i<40; i++) {
                    let f = document.createElement('div'); f.className = 'flake';
                    let s = Math.random()*3+2; f.style.width=s+'px'; f.style.height=s+'px';
                    f.style.left=Math.random()*100+'%';
                    f.style.animationDuration=(Math.random()*10+10)+'s';
                    // ОТРИЦАТЕЛЬНАЯ задержка = мгновенное появление по всей высоте
                    f.style.animationDelay = '-' + (Math.random()*20)+'s';
                    f.style.filter=`blur(${Math.random()}px)`;
                    f.style.opacity=Math.random()*0.5+0.1;
                    particleBox.appendChild(f);
                }
            }
            // 1: ДОЖДЬ (ПРИЯТНЫЙ)
            else if(mode === 1) {
                document.body.className = 'mode-rain';
                moodIcon.className = 'fas fa-cloud-showers-heavy';
                for(let i=0; i<80; i++) { // Больше капель
                    let d = document.createElement('div'); d.className = 'rain-drop';
                    d.style.left=Math.random()*100+'%';
                    d.style.height = (Math.random()*20 + 10) + 'px'; // Разная длина
                    d.style.animationDuration=(Math.random()*0.5+0.4)+'s'; // Очень быстро
                    // Отрицательная задержка
                    d.style.animationDelay = '-' + Math.random()+'s';
                    particleBox.appendChild(d);
                }
            }
            // 2: УГЛИ
            else if(mode === 2) {
                document.body.className = 'mode-ember';
                moodIcon.className = 'fas fa-fire';
                for(let i=0; i<30; i++) {
                    let e = document.createElement('div'); e.className = 'ember-spark';
                    let s = Math.random()*4+2; e.style.width=s+'px'; e.style.height=s+'px';
                    e.style.left=Math.random()*100+'%';
                    e.style.animationDuration=(Math.random()*5+4)+'s';
                    e.style.animationDelay = '-' + (Math.random()*10)+'s';
                    e.style.opacity=Math.random()*0.6+0.2;
                    particleBox.appendChild(e);
                }
            }
        }

        initParticles(0);

        function changeAtmosphere() {
            currentMode++;
            if(currentMode > 2) currentMode = 0;

            // Плавное исчезновение старых частиц
            particleBox.classList.add('fading');

            // Ждем завершения fade out анимации, затем меняем частицы
            setTimeout(() => {
                initParticles(currentMode);
                // Убираем класс fading для fade in эффекта
                particleBox.classList.remove('fading');
            }, 300);
        }

        // --- ЛОГИКА ---
        const audio = document.getElementById('audio');
        const fileInput = document.getElementById('file-input');
        const appContainer = document.getElementById('appContainer');
        const playlistBox = document.getElementById('playlistBox');
        const playlistCount = document.getElementById('count');

        const art = document.getElementById('art');
        const titleEl = document.getElementById('title');
        const artistEl = document.getElementById('artist');
        const playBtn = document.getElementById('playBtn');
        const fill = document.getElementById('fill');
        const aura = document.getElementById('aura');

        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchStatus = document.getElementById('searchStatus');
        const searchResultsBox = document.getElementById('searchResults');

        const bridgeAPI = window.electronAPI || {};
        const supportsItunesSearch = typeof bridgeAPI.searchITunes === 'function';
        const DEFAULT_ART = 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=600&auto=format&fit=crop';

        let playlist = [];
        let currentIdx = 0;
        let isPlaying = false;
        let audioCtx, analyser, dataArray;
        let setupDone = false;
        let animationId;

        if (!supportsItunesSearch && searchStatus) {
            searchStatus.innerText = 'Поиск iTunes недоступен в этой сборке';
        }

        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) {
                    searchStatus.innerText = 'Введите запрос для поиска';
                    return;
                }
                performItunesSearch(query);
            });
        }

        window.addEventListener('dragover', e => { e.preventDefault(); document.querySelector('.drag-msg').parentNode.parentNode.classList.add('drag-active'); document.querySelector('.drag-msg').style.opacity = '1'; });
        window.addEventListener('dragleave', e => { if(!e.relatedTarget || !appContainer.contains(e.relatedTarget)) { document.querySelector('.drag-msg').style.opacity = '0'; }});
        window.addEventListener('drop', e => {
            e.preventDefault(); document.querySelector('.drag-msg').style.opacity = '0';
            if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        async function performItunesSearch(query) {
            if (!supportsItunesSearch) {
                searchStatus.innerText = 'Поиск iTunes недоступен';
                return;
            }
            searchStatus.innerText = 'Поиск в iTunes...';
            searchResultsBox.innerHTML = '';
            try {
                const result = await bridgeAPI.searchITunes(query);
                if (!result || !result.success) {
                    searchStatus.innerText = result?.error || 'Ошибка поиска';
                    return;
                }
                renderSearchResults(result.tracks || []);
            } catch (err) {
                console.error('iTunes search failed', err);
                searchStatus.innerText = 'Ошибка соединения';
            }
        }

        function renderSearchResults(tracks) {
            searchResultsBox.innerHTML = '';
            if (!tracks.length) {
                searchStatus.innerText = 'Ничего не найдено';
                return;
            }

            const playable = tracks.filter(track => track.previewUrl);
            if (!playable.length) {
                searchStatus.innerText = 'Ничего не найдено для прослушивания';
                return;
            }

            searchStatus.innerText = `Найдено треков: ${playable.length}`;
            playable.forEach(track => {
                const item = document.createElement('div');
                item.className = 'search-item';

                const cover = document.createElement('img');
                cover.className = 'search-cover';
                cover.src = (track.artworkUrl100 || DEFAULT_ART).replace('100x100', '200x200');

                const info = document.createElement('div');
                info.className = 'search-info';

                const title = document.createElement('div');
                title.className = 'search-title';
                title.textContent = track.trackName || 'Без названия';

                const artist = document.createElement('div');
                artist.className = 'search-artist';
                artist.textContent = track.artistName || 'Неизвестный исполнитель';

                info.appendChild(title);
                info.appendChild(artist);

                const addBtn = document.createElement('button');
                addBtn.className = 'search-add';
                addBtn.type = 'button';
                addBtn.innerText = 'Добавить';
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addItunesTrack(track);
                });

                item.addEventListener('click', () => addItunesTrack(track));

                item.appendChild(cover);
                item.appendChild(info);
                item.appendChild(addBtn);

                searchResultsBox.appendChild(item);
            });
        }

        function addItunesTrack(track) {
            if (!track || !track.previewUrl) return;
            const id = `itunes-${track.trackId || Math.random().toString(36).substr(2, 9)}`;
            playlist.push({
                id,
                type: 'itunes',
                source: 'iTunes',
                name: track.trackName || 'Без названия',
                artist: track.artistName || 'Неизвестный исполнитель',
                src: track.previewUrl,
                artwork: track.artworkUrl100 ? track.artworkUrl100.replace('100x100', '600x600') : DEFAULT_ART
            });
            renderPlaylist();
            if (playlist.length === 1) {
                loadTrack(0);
            }
            appContainer.classList.add('playlist-open');
        }

        function createLocalArtwork(seed) {
            return `https://source.unsplash.com/random/600x600/?space,neon,blue&sig=${seed}`;
        }

        function handleFiles(files) {
            let newTracks = Array.from(files).filter(f => f.type.startsWith('audio'));
            if(newTracks.length === 0) return;
            newTracks.forEach(file => {
                const id = `local-${Math.random().toString(36).substr(2, 9)}`;
                playlist.push({
                    name: file.name.replace(/\.[^/.]+$/, ""),
                    src: URL.createObjectURL(file),
                    id,
                    type: 'local',
                    source: 'Local',
                    artist: 'Local Audio',
                    artwork: createLocalArtwork(id)
                });
            });
            renderPlaylist();
            if(playlist.length === newTracks.length) loadTrack(0);
            if(playlist.length > 0) appContainer.classList.add('playlist-open');
        }

        function renderPlaylist() {
            playlistBox.innerHTML = '';
            playlistCount.innerText = playlist.length;
            playlist.forEach((track, idx) => {
                const div = document.createElement('div');
                div.className = `track-item ${idx === currentIdx ? 'active' : ''}`;
                div.addEventListener('click', () => loadTrack(idx));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'track-delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    removeTrack(idx);
                });

                const textWrapper = document.createElement('div');
                textWrapper.className = 'track-text';

                const nameEl = document.createElement('div');
                nameEl.className = 't-name-mini';
                nameEl.textContent = track.name;

                const artistElMini = document.createElement('div');
                artistElMini.className = 't-artist-mini';
                artistElMini.textContent = track.artist || '';

                textWrapper.appendChild(nameEl);
                textWrapper.appendChild(artistElMini);

                div.appendChild(deleteBtn);
                div.appendChild(textWrapper);

                if (track.source) {
                    const sourcePill = document.createElement('span');
                    sourcePill.className = 'source-pill';
                    sourcePill.textContent = track.source;
                    div.appendChild(sourcePill);
                }

                playlistBox.appendChild(div);
            });
        }

        function removeTrack(idx) {
            // Удаляем трек из плейлиста
            playlist.splice(idx, 1);

            // Если удалили текущий трек
            if (idx === currentIdx) {
                if (playlist.length === 0) {
                    // Плейлист пуст
                    audio.pause();
                    audio.src = '';
                    isPlaying = false;
                    titleEl.innerText = 'Aether System';
                    artistEl.innerText = 'System Online';
                    art.src = DEFAULT_ART;
                    playBtn.innerHTML = '<i class="fas fa-play" style="margin-left: 4px;"></i>';
                    currentIdx = 0;
                } else {
                    // Загружаем следующий трек или предыдущий
                    if (currentIdx >= playlist.length) currentIdx = 0;
                    loadTrack(currentIdx);
                }
            } else if (idx < currentIdx) {
                // Если удалили трек до текущего, сдвигаем индекс
                currentIdx--;
            }

            renderPlaylist();
        }

        function loadTrack(idx) {
            if (!playlist[idx]) return;
            art.classList.add('fade-transition');
            titleEl.style.opacity = '0';
            artistEl.style.opacity = '0';

            setTimeout(() => {
                currentIdx = idx;
                const track = playlist[idx];
                audio.src = track.src;
                titleEl.innerText = track.name || 'Без названия';
                artistEl.innerText = track.artist || 'Неизвестный исполнитель';
                art.src = track.artwork || DEFAULT_ART;

                art.onload = () => { art.classList.remove('fade-transition'); };
                setTimeout(() => art.classList.remove('fade-transition'), 200);

                titleEl.style.opacity = '1';
                artistEl.style.opacity = '1';
                renderPlaylist();
                playAudio();
            }, 400);
        }

        function togglePlay() {
            if(!playlist.length) return fileInput.click();
            isPlaying ? pauseAudio() : playAudio();
        }

        function playAudio() {
            if(!setupDone) setupViz();
            audio.play();
            isPlaying = true;
            document.body.classList.add('playing');
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            vizLoop();
        }

        function pauseAudio() {
            audio.pause();
            isPlaying = false;
            document.body.classList.remove('playing');
            playBtn.innerHTML = '<i class="fas fa-play" style="margin-left: 4px;"></i>';
            cancelAnimationFrame(animationId);
            aura.style.opacity = 0;
            aura.style.transform = 'scale(1)';
        }

        function nextTrack() {
            let next = currentIdx + 1;
            if(next >= playlist.length) next = 0;
            loadTrack(next);
        }

        function prevTrack() {
            let prev = currentIdx - 1;
            if(prev < 0) prev = playlist.length - 1;
            loadTrack(prev);
        }

        function togglePlaylist() {
            appContainer.classList.toggle('playlist-open');
        }

        audio.addEventListener('ended', nextTrack);

        function setupViz() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            let source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 64;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            setupDone = true;
        }

        function vizLoop() {
            if(!isPlaying) return;
            animationId = requestAnimationFrame(vizLoop);
            analyser.getByteFrequencyData(dataArray);
            let bass = 0; for(let i=0; i<5; i++) bass += dataArray[i];
            bass = bass / 5;
            let scale = 1 + (bass / 255) * 0.5;
            let opacity = (bass / 255) * 0.8;
            aura.style.transform = `scale(${scale})`;
            aura.style.opacity = opacity;
            playBtn.style.boxShadow = `0 0 ${20 + bass/3}px var(--accent-glow)`;
        }

        audio.addEventListener('timeupdate', () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            fill.style.width = pct + '%';
            document.getElementById('curr').innerText = fmt(audio.currentTime);
            document.getElementById('dur').innerText = fmt(audio.duration || 0);
        });

        document.getElementById('seek-bar').addEventListener('click', (e) => {
            const w = document.getElementById('seek-bar').clientWidth;
            audio.currentTime = (e.offsetX / w) * audio.duration;
        });

        function fmt(s) {
            let m=Math.floor(s/60), sec=Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }
    </script>
</body>
</html>
